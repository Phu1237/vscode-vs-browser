<!DOCTYPE html>
<html>
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link rel="stylesheet" href="{ codiconsCss }" />
    <link rel="stylesheet" href="{ browserCss }" />
    <script src="{ jqueryJS }"></script>
    { localProxyServerScript } { localProxyServerForceLocationScript }
  </head>

  <body>
    <div id="navbar">
      <button id="btn-reload" title="Reload">
        <i id="btn-reload--icon" class="codicon codicon-refresh"></i>
      </button>
      <!-- addressbar -->
      <input type="text" id="addressbar" placeholder="Url" />
      <!-- go to url -->
      <button id="btn-go" title="Go to URL">
        <svg
          xmlns="http://www.w3.org/2000/svg"
          width="25"
          height="25"
          fill="currentColor"
          class="bi bi-box-arrow-in-right"
          viewBox="0 0 16 16"
        >
          <path
            fill-rule="evenodd"
            d="M6 3.5a.5.5 0 0 1 .5-.5h8a.5.5 0 0 1 .5.5v9a.5.5 0 0 1-.5.5h-8a.5.5 0 0 1-.5-.5v-2a.5.5 0 0 0-1 0v2A1.5 1.5 0 0 0 6.5 14h8a1.5 1.5 0 0 0 1.5-1.5v-9A1.5 1.5 0 0 0 14.5 2h-8A1.5 1.5 0 0 0 5 3.5v2a.5.5 0 0 0 1 0v-2z"
          />
          <path
            fill-rule="evenodd"
            d="M11.854 8.354a.5.5 0 0 0 0-.708l-3-3a.5.5 0 1 0-.708.708L10.293 7.5H1.5a.5.5 0 0 0 0 1h8.793l-2.147 2.146a.5.5 0 0 0 .708.708l3-3z"
          />
        </svg>
      </button>
      <button id="btn-inspect" title="Inspect">
        <i class="codicon codicon-inspect"></i>
      </button>
      <button id="btn-go-to-settings" title="Go to Settings">
        <i class="codicon codicon-settings-gear"></i>
      </button>
    </div>
    <div class="webview-container">
      <iframe is="using-proxy" id="webview" frameborder="0"></iframe>
    </div>
    <script>
      $(document).ready(function () {
        const vscode = acquireVsCodeApi(); // VS Code API

        let iframe = $("#webview");

        let btn_reload = $("#btn-reload");
        let btn_go = $("#btn-go");
        let btn_inspect = $("#btn-inspect");
        let btn_go_to_settings = $("#btn-go-to-settings");

        // Set address
        let addressbar = $("#addressbar");
        let url = autoCompleteUrl({ url });
        addressbar.val({ url });
        iframe.attr("src", { url });

        function setVSCodeState(options) {
          let state = {
            proxyMode: { proxyMode },
            url: { url },
            autoCompleteUrl: { autoCompleteUrl },
            localProxyServerEnable: { localProxyServerEnabled },
            localProxyServerPort: { localProxyServerPort },
            autoReloadDurationEnabled: { autoReloadDurationEnabled },
            autoReloadDurationTime: { autoReloadDurationTime },
            viewType: { viewType },
            title: { title },
          };

          vscode.setState({
            ...state,
            ...options,
          });
        }
        // Set a restore point for the webview
        setVSCodeState({
          url: url,
        });

        if ({ autoReloadDurationEnabled }) {
          btn_reload.addClass("active");
        }
        if ({ proxyMode }) {
          // Watch to update addressbar
          const observer = new MutationObserver(function () {
            let url = iframe.attr("srcurl") || { url };
            addressbar.value = url;

            let proxyMode = { proxyMode };
            if (url && url.match(/^http:\/\/localhost/g)) {
              proxyMode = false;
            }
            setVSCodeState({
              proxyMode: proxyMode,
              url: url,
            });
          });
          observer.observe(iframe[0], {
            attributes: true,
            attributeFilter: ["srcurl"],
          });
          // Append proxy script to the page content
          let script = $('<script type="module" src="{ proxyJS }" />');
          $("body").append(script);
        }

        // Receive message from webview
        window.addEventListener("message", (event) => {
          const message = event.data; // The JSON data our extension sent

          switch (message.command) {
            case { CONST_WEBVIEW_POST_MESSAGE_COMMAND_RELOAD }:
              reloadIframe();
              break;
          }
        });
        addressbar.on("keyup", function (event) {
          // Number 13 is the "Enter" key on the keyboard
          if (event.keyCode === 13) {
            // Cancel the default action, if needed
            event.preventDefault();
            addressbar.blur();
            // Trigger the button element with a click
            btn_go.click();
          }
        });

        /**
         * Button handler
         */
        btn_reload.on("click", function () {
          reloadIframe();
        });
        btn_go.on("click", function () {
          let url = addressbar.val();
          reloadIframe(url);
          if (!{ proxyMode }) {
            setVSCodeState({
              url: url,
            });
          }
        });
        btn_inspect.on("click", function () {
          vscode.postMessage({
            command: "open-inspector",
          });
        });
        btn_go_to_settings.on("click", function () {
          vscode.postMessage({
            command: "go-to-settings",
          });
        });

        // Just run when iframe first loaded
        let reloadTimeout = null;
        iframe.on("load", function () {
          btn_reload.removeClass("loading");
          if ({ autoReloadDurationEnabled }) {
            clearTimeout(reloadTimeout);
            reloadTimeout = setTimeout(reloadIframe, { autoReloadDurationTime });
          }
        });

        function autoCompleteUrl(url) {
          if (!/^https?:\/\//i.test(url)) {
            // If not, prepend 'http://'
            url = { autoCompleteUrl } + url;
          }
          return url;
        }

        function reloadIframe(src = addressbar.val()) {
          btn_reload.addClass("loading");
          iframe.attr("src", autoCompleteUrl(src));
          url = autoCompleteUrl(src);
          console.log("reloadIframe: " + autoCompleteUrl(src));
        }
      });
    </script>
  </body>
</html>
